@using System.Text;
@using System.Text.RegularExpressions;
@using FCStore.Common;
@using FCStore.Models;
@using FCStore.Controllers;

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    @Styles.Render("~/Content/css")
    @Styles.Render("~/Content/themes/base/css")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <header>
        <div id="Brands">
            <ul>
                <li class="FCIcon">
                    <div class="icon">
                        <img src="/Brand/FC.jpg" alt="FC Icon" />
                    </div>
                    <div class="name cut">
                        FC Store
                    </div>
                </li>
                @{Html.RenderAction("_BrandList", "Brand");}
            </ul>
            <div class="pullupDiv"></div>
        </div>
        <div id="Toolbar">
            <label class="title">搜索：</label>
            <input type="text" />
            <div id="userArea">
                @if (Session["User"] != null)
                {
                    <div>
                        登陆成功
                    </div>
                }
                else
                {
                    if(User.Identity.IsAuthenticated)
                    {
                        <label class="title">欢迎<a href="/User/Details">@(User.Identity.Name)</a>光临RightGO美国代购网！</label>
                        <a href="/User/Exit">退出</a>
                    }
                    else
                    {
                        string tmpStr = Convert.ToBase64String(Encoding.UTF8.GetBytes(HttpContext.Current.Request.Url.AbsoluteUri));
                        <a href="/Home/Login/@(tmpStr)">
                            请登陆
                        </a>
                        <label> | </label>
                        <a href="/Home/Register/@(tmpStr)">
                            免费注册
                        </a>
                    }
                }
            </div>
        </div>
    </header>
    <div id="Main">
        <div id="Center">
            @RenderBody()
        </div>
    </div>
    <nav id="Categorys">
        @{Html.RenderAction("_CategoryList", "Category");}
    </nav>
    <div id="TopBtn" onclick="MainLayout.onTopBtnClick(this);">
        <div class="title">回到顶部</div>
    </div>
    <div id="Contact">
    </div>
    <div id="Favorite" onclick="">
        <div class="relativeDiv">
            <div id="plInFavorit">
@{
    //获得cookie
    if (Request.Cookies.AllKeys.Contains("Keeps"))
    {
        Regex cookieRgx = new Regex(FCStore.Controllers.KeepController.KEEPCOOKIERGX);
        Match tmpMatch = cookieRgx.Match(Server.UrlDecode(Request.Cookies["Keeps"].Value));
        if (!string.IsNullOrEmpty(tmpMatch.Value))
        {
            for (int i = 0; i < tmpMatch.Groups["KITEM"].Captures.Count; i++)
            {
                <a class="MoveItem" href="/Product/Detail/@(tmpMatch.Groups["PRODUCTID"].Captures[i].Value)">
                    <img src="@(tmpMatch.Groups["IMG"].Captures[i].Value)" />
                    <label>
                        @(tmpMatch.Groups["TITLE"].Captures[i].Value)
                    </label>
                </a>
            }
        }
    }
    else if (HttpContext.Current.User.Identity.IsAuthenticated)
    {
        //获得当前用户收藏的东西
        MyUser user = HttpContext.Current.User as MyUser;
        FCStoreDbContext db = new FCStoreDbContext();
        List<Keep> keeplst = db.Keeps.Where(r => r.UID == user.UID).ToList();
        foreach (Keep keepItem in keeplst)
        {
            <a class="MoveItem" href="/Product/Detail/@(keepItem.Product.PID)">
                <img src="@(keepItem.Product.ImgPathArr[0])" />
                <label>
                    @(keepItem.Product.Title)
                </label>
            </a>
        }
        db.Dispose();
    }
}
            </div>
        </div>
    </div>
@{
    bool showCart = true;
    showCart = Request.Url.AbsolutePath.IndexOf("/Order/Cart") > -1;
}
    <div id="Cart" style="@(showCart ? "visibility:hidden" : "")" >
        <div class="relativeDiv">
            <div id="plInCar">
@{
    //获得cookie
    bool sTag = Request.Cookies.AllKeys.Contains("Order");
    if (sTag)
    {
        Regex cookieRgx = new Regex(FCStore.Controllers.ProductController.ORDERCOOKIERGX);
        Match tmpMatch = cookieRgx.Match(Server.UrlDecode(Request.Cookies["Order"].Value));
        sTag = !string.IsNullOrEmpty(tmpMatch.Value);
        if (sTag)
        {
            for (int i = 0; i < tmpMatch.Groups["TITLE"].Captures.Count; i++)
            {
                int BuyCount = 1;
                int.TryParse(tmpMatch.Groups["COUNT"].Captures[i].Value, out BuyCount);
                <div class="MoveItem">
                    <div class="deleteBtn" onclick="MainLayout.onDeleteCarItem(this)">X</div>
                    <a href="/Product/Detail/@(tmpMatch.Groups["PID"].Captures[i].Value)">
                        <div class="countShow" style="display:@(BuyCount > 1 ? "normal" : "none")">@(BuyCount)</div>
                        <img src="@(tmpMatch.Groups["IMG"].Captures[i].Value)" />
                        <label>
                            @(tmpMatch.Groups["TITLE"].Captures[i].Value)
                        </label>
                    </a>
                </div>
            }
        }
    }
    if (!sTag && HttpContext.Current.User.Identity.IsAuthenticated)
    {
        //获得当前用户未处理的订单
        MyUser user = HttpContext.Current.User as MyUser;
        FCStoreDbContext db = new FCStoreDbContext();
        Order order = db.Orders.OrderByDescending(r => r.OID).FirstOrDefault(r => r.UID == user.UID && r.Status == (int)Order.EOrderStatus.OS_Init);
        if (order != null && order.Packets != null)
        {
            foreach (OrderPacket tmpOP in order.Packets)
            {
                <div class="MoveItem">
                    <div class="deleteBtn" onclick="MainLayout.onDeleteCarItem(this)">X</div>
                    <a href="/Product/Detail/@(tmpOP.Product.PID)">
                        <div class="countShow" style="display:@(tmpOP.Count > 1 ? "normal" : "none")">@(tmpOP.Count)</div>
                        <img src="@(tmpOP.Product.ImgPathArr[0])" />
                        <label>
                            @(tmpOP.Product.Title)
                        </label>
                    </a>
                </div>
            }
        }
        db.Dispose();
    }
}
            </div>
            <a class="balance" href="/Order/Cart"></a>
        </div>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/main")
    @RenderSection("scripts", required: false)

    <footer>

    </footer>
</body>
</html>
