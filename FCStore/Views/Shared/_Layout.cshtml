@using System.Text;
@using System.Text.RegularExpressions;
@using FCStore.Common;
@using FCStore.Models;
@using FCStore.Controllers;

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta property="qc:admins" content="025473637762170477636" />       <!--qq登陆接口认证-->
    <meta property="wb:webmaster" content="a0b16827b5ccd126" />         <!--微博登陆接口认证-->

    <title>@ViewBag.Title</title>
    @Styles.Render("~/Content/css")
    @Styles.Render("~/Content/themes/base/css")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <header>
        <div id="Toolbar">
            <label class="title">搜索：</label>
            <input type="text" />
            <div id="userArea">
                <span id="qqLoginBtn" ></span>
                <span id="wb_connect_btn"></span>
                <div class="VADiv">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <label class="title">欢迎<a href="/User/Details">@(User.Identity.Name)</a>光临RightGO美国代购网！</label>
                        <a href="/User/Exit">退出</a>
                    }
                    else
                    {
                        string tmpStr = Convert.ToBase64String(Encoding.UTF8.GetBytes(HttpContext.Current.Request.Url.AbsoluteUri));
                        <label> | </label>
                        <a href="/Home/Login/@(tmpStr)">
                            请登陆
                        </a>
                        <label> | </label>
                        <a href="/Home/Register/@(tmpStr)">
                            免费注册
                        </a>
                    }
                </div>
            </div>
        </div>
    </header>
    <div id="Main">
        <div id="Center">
            @RenderBody()
            <div class="pullupDiv"></div>
        </div>
    </div>
    <nav id="Categorys">
        @{Html.RenderAction("_CategoryList", "Category");}
    </nav>
    <div id="TopBtn" onclick="MainLayout.onTopBtnClick(this);">
        <div class="title">回到顶部</div>
    </div>
    <div id="Contact">
    </div>
    <div id="Favorite" onclick="ProductList.onFavoriteClick()">
        <div class="relativeDiv">
            <div id="plInFavorit">
@{
    //获得cookie
    if (Request.Cookies.AllKeys.Contains("Keeps"))
    {
        Regex cookieRgx = new Regex(FCStore.Controllers.KeepController.KEEPCOOKIERGX);
        Match tmpMatch = cookieRgx.Match(Server.UrlDecode(Request.Cookies["Keeps"].Value));
        if (!string.IsNullOrEmpty(tmpMatch.Value))
        {
            for (int i = 0; i < tmpMatch.Groups["KITEM"].Captures.Count; i++)
            {
                <a data="@(tmpMatch.Groups["PRODUCTID"].Captures[i].Value)" class="MoveItem" href="/Product/Detail/@(tmpMatch.Groups["PRODUCTID"].Captures[i].Value)">
                    <img src="@(tmpMatch.Groups["IMG"].Captures[i].Value)" />
                    <label>
                        @(tmpMatch.Groups["TITLE"].Captures[i].Value)
                    </label>
                </a>
            }
        }
    }
    else if (HttpContext.Current.User.Identity.IsAuthenticated)
    {
        //获得当前用户收藏的东西
        MyUser user = HttpContext.Current.User as MyUser;
        FCStoreDbContext db = new FCStoreDbContext();
        List<Keep> keeplst = db.Keeps.Where(r => r.UID == user.UID).ToList();
        foreach (Keep keepItem in keeplst)
        {
            <a class="MoveItem" href="/Product/Detail/@(keepItem.Product.PID)">
                <img src="@(keepItem.Product.ImgPathArr[0])" />
                <label>
                    @(keepItem.Product.Title)
                </label>
            </a>
        }
        db.Dispose();
    }
}
            </div>
        </div>
    </div>
@{
    bool showCart = true;
    showCart = Request.Url.AbsolutePath.IndexOf("/Order/Cart") > -1;
}
    <div id="Cart" style="@(showCart ? "visibility:hidden" : "")" >
        <div class="relativeDiv">
            <div id="plInCar">
@{
    //获得cookie
    bool sTag = Request.Cookies.AllKeys.Contains("Order");
    if (sTag)
    {
        Regex cookieRgx = new Regex(FCStore.Controllers.ProductController.ORDERCOOKIERGX);
        Match tmpMatch = cookieRgx.Match(Server.UrlDecode(Request.Cookies["Order"].Value));
        sTag = !string.IsNullOrEmpty(tmpMatch.Value);
        if (sTag)
        {
            for (int i = 0; i < tmpMatch.Groups["TITLE"].Captures.Count; i++)
            {
                int BuyCount = 1;
                int.TryParse(tmpMatch.Groups["COUNT"].Captures[i].Value, out BuyCount);
                <div class="MoveItem">
                    <div class="deleteBtn" onclick="MainLayout.onDeleteCarItem(this)">X</div>
                    <a href="/Product/Detail/@(tmpMatch.Groups["PID"].Captures[i].Value)">
                        <div class="countShow" style="display:@(BuyCount > 1 ? "normal" : "none")">@(BuyCount)</div>
                        <img src="@(tmpMatch.Groups["IMG"].Captures[i].Value)" />
                        <label>
                            @(tmpMatch.Groups["TITLE"].Captures[i].Value)
                        </label>
                    </a>
                </div>
            }
        }
    }
    if (!sTag && HttpContext.Current.User.Identity.IsAuthenticated)
    {
        //获得当前用户未处理的订单
        MyUser user = HttpContext.Current.User as MyUser;
        FCStoreDbContext db = new FCStoreDbContext();
        Order order = db.Orders.OrderByDescending(r => r.OID).FirstOrDefault(r => r.UID == user.UID && r.Status == (int)Order.EOrderStatus.OS_Init);
        if (order != null && order.Packets != null)
        {
            foreach (OrderPacket tmpOP in order.Packets)
            {
                <div class="MoveItem">
                    <div class="deleteBtn" onclick="MainLayout.onDeleteCarItem(this)">X</div>
                    <a href="/Product/Detail/@(tmpOP.Product.PID)">
                        <div class="countShow" style="display:@(tmpOP.Count > 1 ? "normal" : "none")">@(tmpOP.Count)</div>
                        <img src="@(tmpOP.Product.ImgPathArr[0])" />
                        <label>
                            @(tmpOP.Product.Title)
                        </label>
                    </a>
                </div>
            }
        }
        db.Dispose();
    }
}
            </div>
            <a class="balance" href="/Order/Cart"></a>
        </div>
    </div>

    <!-- QQ在线客服 -->
    <div id='qq_icon'></div>
    <div id='cs_online'>
        <ul class='qq_context'>
            <li>
                <span class='span_t'>在线客服01：</span>
                <span class='qq_num'></span>
            </li>
            <li>
                <span class='span_t'>在线客服02：</span>
                <span class='qq_num'></span>
            </li>
            <li>
                <span class='span_t'>在线客服03：</span>
                <span class='qq_num'></span>
            </li>
            <li>
                <span class='span_t'>在线客服04：</span>
                <span class='qq_num'></span>
            </li>
            <li>
                <span class='span_t'>在线客服05：</span>
                <span class='qq_num'></span>
            </li>
        </ul>
    </div>

    <footer>
        <div class="centerDiv">
            <label>Copyright  2004-2014  RightGO网  All Rights Reserved <a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action">粤ICP备14045853号-1</a></label>
        </div>
    </footer>
    @{Html.RenderAction("_BrandList", "Brand");}

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/jquerylazyload")
    @*@Scripts.Render("~/bundles/main")*@

    <script type="text/javascript" charset="utf-8" src="~/Scripts/common.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/Scripts/sidebar-follow-jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/Scripts/qqReport.js"></script>
    <script type="text/javascript" charset="utf-8" src="~/Scripts/main.js"></script>
    @RenderSection("scripts", required: false)

<!--Other Login-->
    <script type="text/javascript" src="http://qzonestyle.gtimg.cn/qzone/openapi/qc_loader.js"
            data-appid="@(System.Configuration.ConfigurationManager.AppSettings["QQAPPID"])"
            data-redirecturi="@(System.Configuration.ConfigurationManager.AppSettings["QQREDIRECTURI"])" charset="utf-8"></script>
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=@(System.Configuration.ConfigurationManager.AppSettings["WEIBOAPPKEY"])"
            type="text/javascript" charset="utf-8"></script>
</body>
</html>
